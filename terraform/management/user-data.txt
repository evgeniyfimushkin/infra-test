#cloud-config
datasource:
 Ec2:
  strict_id: false
ssh_pwauth: no
users:
- name: evgeniyfim
  sudo: ALL=(ALL) NOPASSWD:ALL
  shell: /bin/bash
  ssh_authorized_keys:
  - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGaUbYmB8Jn2gfaEHQDqZej9Yn/3Rpfif1oDjJGvxyF+rnFJ9RXM5ofQTjVPgucd5KvoFoJMhsjww+OmMyA5QMw=
write_files:
  - path: "/usr/local/etc/startup.sh"
    permissions: "755"
    content: |
      #!/bin/bash

      apt-get update
      apt-get install -y git ansible

      mkdir /home/evgeniyfim/git
      cd /home/evgeniyfim/git
      git clone https://github.com/evgeniyfimushkin/infra-test.git
      
      cp /home/evgeniyfim/git/infra-test/terraform/management/terraform /usr/local/bin/
      chmod +x /usr/local/bin/terraform
      
      curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash

     
      echo 'export YC_TOKEN=$(yc iam create-token)' >> /home/evgeniyfim/.bashrc
      echo 'export YC_CLOUD_ID=$(yc config get cloud-id)' >> /home/evgeniyfim/.bashrc
      echo 'export YC_FOLDER_ID=$(yc config get folder-id)' >> /home/evgeniyfim/.bashrc

      cat > /home/evgeniyfim/.terraformrc <<EOF
      provider_installation {
        network_mirror {
          url = "https://terraform-mirror.yandexcloud.net/"
          include = ["registry.terraform.io/*/*"]
        }
        direct {
          exclude = ["registry.terraform.io/*/*"]
        }
      }
      EOF


 

      rm /home/evgeniyfim/git/infra-test/terraform/cluster/.terraform.lock.hcl
      chown -R 1000:1000 /home/evgeniyfim/git
      
    defer: true
runcmd:
  - ["/usr/local/etc/startup.sh"]
